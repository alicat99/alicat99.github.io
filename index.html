<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Authentication Example</title>
    <style>
        /* 스타일 추가 */
        .auth {
            display: none;
        }

        .noauth {
            display: none;
        }

        .loggedIn .auth {
            display: block;
        }

        .loggedIn .noauth {
            display: none;
        }

        .loggedOut .auth {
            display: none;
        }

        .loggedOut .noauth {
            display: block;
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAUovFUyahYm7AZkF9wM_V2w5yGmtHWzes",
          authDomain: "login-test-7ead5.firebaseapp.com",
          projectId: "login-test-7ead5",
          storageBucket: "login-test-7ead5.appspot.com",
          messagingSenderId: "409455176587",
          appId: "1:409455176587:web:ac17e5073a11a4a09d9d8e",
          measurementId: "G-3FTFGPX4BN"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Email and Password Sign Up
        window.signUpWithEmail = function signUpWithEmail() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // 회원가입 성공
                    const user = userCredential.user;
                    console.log("Email SignUp successful:", user);
                    alert("Email SignUp successful!");
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.error("Error signing up with email:", errorCode, errorMessage);
                    alert("Error signing up with email: " + errorMessage);
                });
        }

        // Email and Password Sign In
        window.signInWithEmail = function signInWithEmail() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // 로그인 성공
                    const user = userCredential.user;
                    console.log("Email SignIn successful:", user);
                    alert("Email SignIn successful!");
                    // 로그인 상태에 따라 클래스 추가
                    document.body.classList.add('loggedIn');
                    document.body.classList.remove('loggedOut');
                    // Firestore에 사용자 데이터 기록
                    setUserData(user.uid, { email: user.email, lastLogin: new Date() });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.error("Error signing in with email:", errorCode, errorMessage);
                    alert("Error signing in with email: " + errorMessage);
                });
        }

        // Google Sign In
        window.signInWithGoogle = function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    // 로그인 성공
                    const user = result.user;
                    console.log("Google SignIn successful:", user);
                    alert("Google SignIn successful!");
                    // 로그인 상태에 따라 클래스 추가
                    document.body.classList.add('loggedIn');
                    document.body.classList.remove('loggedOut');
                    // Firestore에 사용자 데이터 기록
                    setUserData(user.uid, { email: user.email, lastLogin: new Date() });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.error("Error signing in with Google:", errorCode, errorMessage);
                    alert("Error signing in with Google: " + errorMessage);
                });
        }

        // Firestore에서 사용자 데이터 읽기 또는 생성
        function setUserData(uid, userData) {
            const userDocRef = doc(db, "users", uid);
            getDoc(userDocRef).then((docSnap) => {
                if (docSnap.exists()) {
                    console.log("User data already exists:", docSnap.data());
                } else {
                    console.log("Creating user data for", uid);
                    setDoc(userDocRef, userData)
                        .then(() => {
                            console.log("User data created successfully!");
                        })
                        .catch((error) => {
                            console.error("Error creating user data:", error);
                        });
                }
            }).catch((error) => {
                console.error("Error getting user data:", error);
            });
        }

        // 페이지가 로드될 때 사용자의 로그인 상태를 확인하여 클래스 추가
        document.addEventListener("DOMContentLoaded", function () {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    document.body.classList.add('loggedIn');
                } else {
                    document.body.classList.add('loggedOut');
                }
            });
        });
    </script>
</head>
<body>
    <h1>Firebase Authentication Example</h1>
    <div class="auth">
        <!-- 로그인 상태에서 보여줄 내용 -->
        <p>Welcome, you are logged in!</p>
    </div>
    <div class="noauth">
        <!-- 로그아웃 상태에서 보여줄 내용 -->
        <h2>Email Sign Up</h2>
        <input type="email" id="signup-email" placeholder="Email">
        <input type="password" id="signup-password" placeholder="Password">
        <button onclick="signUpWithEmail()">Sign Up with Email</button>

        <h2>Email Sign In</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="signInWithEmail()">Sign In with Email</button>

        <h2>Google Sign In</h2>
        <button onclick="signInWithGoogle()">Sign In with Google</button>
    </div>
</body>
</html>
